# 数仓理论

## （一）数据仓库

### 1、什么是数据仓库

-   信息仓库：`Information WareHouse`

-   数据仓库

    >   Data Warehouse

    -   概念来自 Gill Inmon

    >   数据仓库是一个面向主题的、集成的、相对稳定的、反应历史变化的数据集合。

### 2、数仓四大特征

1.  面向主题的 *Subject Oriented*
2.  集成的 *Integrated*
3.  相对稳定的 *Non-Volatile*
4.  反映历史变化的 *Time Variant*

### 3、数仓与数据库的区别

-   数仓与数据库的比较相当于 OLTP 与 OLAP的比较
    -   OLTP，On-Line Transaction Processing
    -   OLAP，On-Line Analytical Processing
-   数仓目的是**分析数据**；数据库目的是**捕获和存储数据**
-   数仓有意引入数据冗余，反范式；数据库尽量避免冗余（第三范式）

*总之，数仓是在数据库早已大量存在的情况下，为了进一步挖掘数据资源以便更好地决策而产生的，绝不是所谓的大型数据库。*

<img src="image\image-20210205113001750.png" />

### 4、数据集市

-   DM，Data Mart

-   数据集市是数据仓库中根据不同子主题创建的局部性数据组织，也成部门数据仓库，是数据仓库的一部分。
-   公司发展初期效果很好，但是到了后期，各个事业部独立建设的各个数据集市彼此之间建设标准不同，相互孤立，因此形成众多的数据孤岛，阻碍企业进一步发展。

## （二）数据建模方法

### 1、ER模型

-   ER，Entity Relationship（实体关系）
-   自上而下建模，从高度抽象到具体细节
-   建设周期长，对建模人员要求非常高

### 2、维度模型

-   从分析决策的需求出发，为分析需求服务，重点关注的是：用户如何更快速地完成需求分析，以及具有较好的大规模查询的相应性能
-   典型代表：<u>星星模型</u>，特殊场景下的<u>雪花模型</u>
-   企业建设数据仓库的经验表明：ER建模风险很大，维度模型更适合快速变化的业务。

## （三）数仓分层

-   数仓分层的好处：

    -   数据结构清晰
    -   复杂问题简单化
    -   减少重复开发
    -   屏蔽原始数据的异常
    -   数据血缘的追踪

-   数仓通常分为三层：**数据操作层**、**数据仓库层**、**应用数据层**（数据集市层）

    <img src="image\image-20210205115633120.png" />

-   **ODS（Operation Data Store）**，数仓源头系统的数据会**原封不动地存储一份**，称为ODS层，也称准备区。它们是后续数据仓库层加工数据的来源。主要包括：
    -   **业务数据库**：用 DataX、Sqoop 等定时抽取；在实时应用中，可用Canal监听 MySql 的 BinLog，实时接入变更的数据。
    -   **埋点日志**：线上系统会打入各种日志，这些日志一般以文件的形式保存，可用Flume定时抽取
    -   **其他数据源**：第三方购买、爬虫

-   **DW（Data Warehouse）**，包括DWD、DWS、DIM层，是由ODS层数据加工而成的。
    -   **DWD（Data Warehouse Detail）**，是业务层与数仓的隔离层。以***业务过程*** 作为建模驱动，基于业务具体过程，构建<u>细粒度</u>的**细层事实表**，也可做宽表化处理。
    -   **DWS（Data Warehouse Service）**，基于DWD的基础数据，整合汇总成分析某一主题域的服务数据。以***分析的主题*** 为建模驱动，基于上层应用的指标需求，构建<u>公共粒度</u>的**汇总指标事实表**。
    -   **DIM（公共维度层）**：基于维度建模思想，建立一致性维度；
    -   **TMP层**：临时层，存放计算过程中产生的临时数据；

-   **ADS（Application Data Store）**，基于DW的数据，汇总整合成主题域的服务数据，用于后续的业务查询和分析等。

## （四）数仓模型

### 1、事实表和维度表

-   **事实表**
    -   在数仓中，保存度量值的详细值或事实的表 ——> 事实表
    -   事实表通常包含大量的行
    -   <u>特点：</u>
        -   包含数字数据（事实），可以汇总，以提供有段单位作为历史的数据
        -   表多（各式各样的事实表）
        -   数据量大
    -   事实表的粒度决定了数仓中数据的详细程度
    -   常见事实表：**订单事实表**
    -   事实表根据粒度分类：
        -   事务事实表
        -   周期快照事实表
        -   累计快照事实表

-   **维度表**
    -   也称维表，可以看作用来分析数据的角度，包含了事实数据表中记录的特性（特性包括：提供描述性信息、指定如何汇总事实表数据等）
    -   常见维度表：时间维度表、地域维度表、商品维度表

-   **小结**
    -   事实表是关注的内容（如销售额等）
    -   维度表是观察事务的角度

### 2、事实表分类

#### ① 事务事实表

-   <u>也叫*原子事实表*，记录的是事务层面的事实，保存的是最原子的数据</u>
-   事务事实表中的数据是在事务时间发生后产生，粒度通常是：每个事务一条记录。一旦事务被提交，事实表数据insert，数据就不再更改，更新方式为 **增量更新**
-   通过事务事实表，还能建立<u>聚集事实表</u>，为用户提供高性能的分析

#### ② 周期快照事实表

-   以**具有规律性的、可预见的时间间隔**来记录事实（如每天、每月、每年）
-   统计的是间隔周期内的度量统计，如历史至今、自然年至今、季度至今等
    -   典型例子：销售日快照表、库存日快照表
-   周期快照事实表粒度是每个时间段一条记录，比事务事实表（一个事务一条记录）粒度粗，是在事务事实表之上建立的聚集表，但是记录的事实比事务事实表多
    -   如：商家日销售表（无论当天是否有销售发生，都记录一行）日期、商家名称、销售量、销售额 . . .

#### ③ 累计快照事实表

-   记录的是：**不确定的周期**的数据，代表的是完全覆盖一个事务或产品的生命周期的时间跨度。
-   通常具有 <u>多个日期字段</u>（用于记录关键时间节点），还会有一个<u>用于指示最后更新日期的附加日期字段</u>
-   许多日期在首次加载是未知的，需要用**代理关键字**来处理未定义的日期，数据加载之后可对其进行更新，以补充随后知道的日期信息，如：订货日期、预定交货日期、实际发货日期、实际交货日期、数量、金额、运费等
-   例子：商家本周、本月累计销售表

### 3、星型模型

-   属于一种多维数据关系：**一个事实表 + 一组维表**

-   **事实表**在中心，**包含大量数据，没有数据冗余**
-   **维表**围绕者事实表，包含一定的数据冗余（**逆规范化**）

<img src="image\image-20210205150414523.png" />

### 4、雪花模型

-   星型模型的变种，**维表**是**规范化**的

-   特点：雪花模型中**<u>去除了数据冗余</u>**

    <img src="image\image-20210205150716699.png" />

#### 星型模型 VS 雪花模型

-   星型模型
    -   数据冗余，查询只需要做少量的表链接，效率高
    -   不考虑维表规范化，设计简单
    -   数据冗余可接受的情况下，使用星型模型的比较多

### 5、事实星座模式

-   数据仓库有多个主题构成，包含多个事实表，但维表是共享的
-   这种模式可以看作星型模型的汇集，故而成为星系模式、事实星座模式
-   特点：公用维表

<img src="image\image-20210205151224439.png" />

## （五）元数据

-   元数据，Metadata，是关于数据的数据
-   元数据打通了源数据、数据仓库、数据应用，记录了数据从产生到消费的全过程
-   元数据相当于所有数据的地图，通过此地图可知
    -   有哪些数据
    -   数据分布情况
    -   数据类型
    -   数据之间的关系
    -   各种数据的使用频率
    -   . . .

-   在大数据平台中，元数据贯穿大数据平台数据流动全过程

    -   数据源元数据
    -   数据加工处理元数据
    -   数据主题库专题库元数据
    -   服务层元数据
    -   应用层元数据

    <img src="image\image-20210205151728951.png" />

-   通常将元数据分为以下类型
    -   **技术元数据**：库表结构、数据模型、ETL程序、SQL程序等
    -   **业务元数据**：业务指标、业务代码、业务术语等
    -   **管理元数据**：数据所有者、数据质量、数据安全等